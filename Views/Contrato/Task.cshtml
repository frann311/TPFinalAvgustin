<div id="task-app" v-cloak class="container-fluid py-4" style="background-color: #f8f9fc;">
    <div class="row justify-content-center">

        <!-- Columna lista de contratos -->
        <div class="col-md-4">
            <h3 class="mb-4 text-primary fw-bold text-center">{{titulo}}</h3>
            <div>
                <button class="btn btn-primary me-2" @@click="switchView('tareasActivas')">Tareas Activas
                    <button class="btn btn-outline-secondary" @@click="switchView('tareasHistorial')">Tareas
                        Canceladas</button>
            </div>
            <div v-if="items.length === 0" class="alert alert-info">
                {{messageNoItems}}
            </div>

            <!-- Card de contrato -->
            <div v-for="t in items" :key="t.id" class="card mb-3 shadow-sm contrato-item" data-bs-toggle="tooltip"
                :title="'Ver detalles de ' + t.vacanteTitulo">
                <div class="card-body" :class="{ 'disabled': !t.isActive }"
                    @@click="t.isActive ? selectTask(t.id) : null">
                    <h5 class="card-title mb-2">{{ t.vacanteTitulo }}</h5>
                    <p class="mb-1"><strong>Fecha inicio:</strong> {{ formatDate(t.fechaCreacion) }}</p>

                    <p v-if="t.isActive" class="mb-1">
                        <strong>Estado:</strong>
                        <span class="badge bg-success">Activo</span>
                    </p>
                    <p v-else-if="t.isCancelled" class="mb-1">
                        <strong>Estado:</strong>
                        <span class="badge bg-danger">Cancelado</span>
                    </p>

                    <!-- Botón para solicitar revisión -->
                    <button v-if="t.estado_disputa == 'Ninguna'" class="btn btn-warning btn-sm mt-2"
                        @@click="solicitarRevision(t.id)">
                        Solicitar revisión
                    </button>

                    <span v-if="t.estado_disputa == 'EnRevision'" class="badge bg-warning text-dark">
                        Solicitud de revisión enviada
                    </span>
                    <span v-if="t.estado_disputa == 'Rechazada'" class="badge bg-danger text-dark">
                        Solicitud de revisión Rechazada
                    </span>
                    <span v-if="t.estado_disputa == 'Aprobada'" class="badge bg-success text-dark">
                        Solicitud de revisión Aprobada
                    </span>

                </div>

            </div>
        </div>

        <!-- Columna detalle del contrato -->
        <div class="col-md-6" v-if="selected">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Contrato</h5>
                </div>
                <div class="card-body">

                    <!-- Info contrato -->
                    <h6 class="text-secondary mb-3">Información del Contrato</h6>
                    <ul class="list-unstyled small">
                        <li><strong>Proyecto:</strong> {{ selected.vacanteTitulo }}</li>
                        <li><strong>Objetivo:</strong> {{ selected.vacanteDescripcion }}</li>
                        <li><strong>Fecha inicio:</strong> {{ formatDate(selected.fechaCreacion) }}</li>
                        <li><strong>Fecha Limite:</strong> {{ selected.fechaLimite ?
                            formatDate(selected.fechaFinalizacion) : 'No definida' }}</li>
                        <li><strong>Estado:</strong> Activo</li>
                    </ul>

                    <hr>





                    <!-- Subida de archivos -->
                    <h6 class="text-secondary mb-3">Subir Archivos</h6>
                    <div class="border p-3 rounded bg-light text-center">
                        <div v-if="error" class="alert alert-danger">{{ error }}</div>
                        <input type="file" class="form-control mb-2" multiple @@change="onFileChange" />
                        <button class="btn btn-primary mt-2" @@click="subirArchivos">Subir</button>
                        <small class="text-muted"> Formatos permitidos: PDF, DOCX, JPG, PNG</small>
                    </div>
                    <button class="btn btn-link mb-3" type="button" data-bs-toggle="collapse"
                        data-bs-target="#archivosCollapse" aria-expanded="false" aria-controls="archivosCollapse">
                        Archivos del Contrato ({{ archivosItem.length }})
                    </button>

                    <!-- Contenedor collapsible -->
                    <div class="collapse" id="archivosCollapse">
                        <ul class="list-group">
                            <li v-for="archivo in archivosItem" :key="archivo.id"
                                class="list-group-item d-flex justify-content-between align-items-center">
                                <a :href="archivo.url" target="_blank" rel="noopener noreferrer"
                                    class="text-decoration-none">
                                    {{ archivo.nombre_original }}
                                </a>
                                <span @@click="deleteArchivo(archivo.id)" class="badge bg-danger">X</span>
                            </li>
                        </ul>
                    </div>


                </div>
                <div class="card-footer text-end">
                    <button @@click="CloseTask()" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .contrato-item {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .contrato-item:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
</style>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {

                // ======================================================
                // ESTADO PRINCIPAL
                // ======================================================
                const items = ref([]);
                const selected = ref(null);
                const archivosItem = ref([]);

                const archivosSeleccionados = ref([]);
                const loading = ref(false);
                const error = ref(null);
                const total = ref(0);

                const titulo = ref("Tareas Activas");
                const messageNoItems = ref("No se encontraron Tareas a realizar.");

                // ======================================================
                // HELPERS
                // ======================================================
                const formatDate = (fecha) =>
                    new Date(fecha).toLocaleDateString();


                // ======================================================
                // API: OBTENCIÓN DE TAREAS
                // ======================================================
                const loadTasks = async () => {
                    try {
                        loading.value = true;

                        const { data } = await axios.get(`/api/contratos/tasks`);
                        items.value = data.items;
                        total.value = data.total;

                        console.log("Tareas cargadas:", items.value);

                    } catch (err) {
                        console.error("Error al cargar tareas:", err);

                    } finally {
                        loading.value = false;
                    }
                };

                const loadHistoricalTasks = async () => {
                    try {
                        loading.value = true;

                        const { data } = await axios.get(`/api/contratos/tasks/historial`);
                        items.value = data.items;
                        total.value = data.total;

                        console.log("Historial cargado:", items.value);

                    } catch (err) {
                        console.error("Error al cargar historial de tareas:", err);

                    } finally {
                        loading.value = false;
                    }
                };


                // ======================================================
                // SELECCIONAR TAREA + ARCHIVOS
                // ======================================================
                const selectTask = async (id) => {
                    try {
                        loading.value = true;

                        const { data } = await axios.get(`/api/contratos/taskById/${id}`);
                        selected.value = data;

                        console.log("Tarea seleccionada:", selected.value);

                        // Archivos asociados
                        try {
                            const archivos = await axios.get(`/api/archivos/${id}`);
                            archivosItem.value = archivos.data;

                            console.log("Archivos de la tarea:", archivosItem.value);

                        } catch (err) {
                            console.error("Error al cargar archivos:", err);
                        }

                    } catch (err) {
                        console.error("Error al seleccionar tarea:", err);

                    } finally {
                        loading.value = false;
                    }
                };


                // ======================================================
                // CAMBIAR ENTRE VISTAS (activas / historial)
                // ======================================================
                const switchView = (view) => {

                    selected.value = null;
                    items.value = [];
                    total.value = 0;

                    if (view === 'tareasActivas') {
                        console.log("Vista: Tareas Activas");

                        titulo.value = "Tareas Activas";
                        messageNoItems.value = "No se encontraron Tareas Activas.";
                        loadTasks();

                    } else if (view === 'tareasHistorial') {
                        console.log("Vista: Tareas Canceladas");

                        titulo.value = "Tareas Canceladas";
                        messageNoItems.value = "No se encontraron Tareas Canceladas.";
                        loadHistoricalTasks();
                    }
                };


                // ======================================================
                // ARCHIVOS
                // ======================================================
                const onFileChange = (evt) => {
                    archivosSeleccionados.value = evt.target.files;
                };

                const subirArchivos = async () => {

                    if (!archivosSeleccionados.value.length) {
                        error.value = "Seleccione al menos un archivo.";
                        return;
                    }

                    const formData = new FormData();
                    const taskId = selected.value.id;

                    for (const file of archivosSeleccionados.value) {
                        formData.append("archivos", file);
                    }

                    formData.append("contratoId", taskId);

                    try {
                        const response = await axios.post('/api/archivos/upload', formData);

                        if (response.status === 200) {

                            archivosSeleccionados.value = [];
                            selected.value = null;

                            // Recargar para ver archivos nuevos
                            selectTask(taskId);

                        } else {
                            alert("Error al subir archivos.");
                        }

                    } catch (err) {
                        console.error(err);
                        alert("Error en la conexión.");
                    }
                };

                const deleteArchivo = async (archivoId) => {
                    try {
                        loading.value = true;

                        await axios.delete(`/api/archivos/${archivoId}`);
                        archivosItem.value = archivosItem.value.filter(a => a.id !== archivoId);

                        console.log("Archivo eliminado:", archivoId);

                    } catch (err) {
                        console.error("Error al eliminar archivo:", err);

                    } finally {
                        loading.value = false;
                    }
                };


                // ======================================================
                // SOLICITAR REVISIÓN DE UNA TAREA
                // ======================================================
                const solicitarRevision = async (taskId) => {
                    try {
                        loading.value = true;

                        await axios.put(`/api/contratos/solicitar-revision/${taskId}`);

                        // Al solicitar revisión → pasa al historial
                        loadHistoricalTasks();

                    } catch (err) {
                        console.error("Error al solicitar revisión:", err);
                        alert("Error al enviar solicitud de revisión.");

                    } finally {
                        loading.value = false;
                    }
                };


                // ======================================================
                // UTILIDADES
                // ======================================================
                const CloseTask = () => {
                    selected.value = null;
                    archivosItem.value = [];
                };


                // ======================================================
                // CARGA INICIAL
                // ======================================================
                loadTasks();


                // ======================================================
                // RETORNO
                // ======================================================
                return {
                    items,
                    selected,
                    archivosItem,
                    archivosSeleccionados,

                    titulo,
                    messageNoItems,
                    loading,
                    error,
                    total,

                    // funciones
                    switchView,
                    selectTask,
                    CloseTask,
                    onFileChange,
                    subirArchivos,
                    deleteArchivo,
                    solicitarRevision,
                    formatDate,
                };
            }
        }).mount('#task-app');
    </script>
}