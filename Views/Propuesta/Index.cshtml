@using System.Security.Claims
@{
    var claimAvatar = User.FindFirstValue("AvatarUrl");
    var avatarUrl = !string.IsNullOrEmpty(claimAvatar)
    ? claimAvatar
    : Url.Content("~/img/default-avatar.jpg");

    var VacantesCreadasCount = ViewBag.VacantesCreadasCount ?? 0;
    var PropuestasEnviadasCount = ViewBag.PropuestasEnviadasCount ?? 0;
}

<div class="container mt-4" v-cloak id="propuestas-app">
    <div class="row">
        <!-- Columna izquierda: perfil y navegación -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body text-center">
                    <img src="@avatarUrl" class="rounded-circle mb-2"
                        style="width:100px; height:100px; object-fit:cover;" alt="Avatar" />
                    <h5 class="card-title">@User.Identity.Name</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="#" @@click.prevent="switchView('PropuestasEnviadas')">Propuestas enviadas</a>
                    </li>
                    <li class="list-group-item">
                        <a href="#" @@click.prevent="switchView('PropuestasRecibidas')">
                            Propuestas recibidas</a>
                    </li>
                </ul>
            </div>

            <div class="card" v-if="viewState==='PropuestasRecibidas'">
                <div class="card-header bg-primary text-white">
                    Mis Vacantes
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center"
                        v-for="vacante in itemsVacantes" :key="vacante.id" @@click="seleccionarVacante(vacante)">
                        <span>{{ vacante.titulo }}</span>
                        <span class="badge bg-secondary rounded-pill">{{ vacante.propuestasCount }}</span>
                    </li>
                </ul>
            </div>
        </div>


        <!-- Columna central: listado de propuestas -->
        <div class="col-md-6">
            <h2>{{title}}</h2>
            <div v-if="loading" class="text-center my-3">
                <div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>
            </div>
            <div v-if="!loading && items.length===0" class="text-center text-muted">
                {{ nonItemaText }}
            </div>

            <ul class="list-group" v-if="viewState==='PropuestasEnviadas' ">
                <li v-for="p in items" :key="p.id" class="list-group-item list-group-item-action position-relative"
                    :class="{ active: selected && selected.id === p.id }" @@click="selectPropuesta(p)">

                    <!-- Badge de estado -->
                    <span v-if="p.isAceptada" class="badge bg-success position-absolute top-0 end-0 m-2">
                        Aceptada
                    </span>
                    <span v-else class="badge bg-secondary position-absolute top-0 end-0 m-2">
                        Pendiente
                    </span>

                    <!-- Contenido principal -->
                    <strong>{{ p.vacante.titulo }}</strong>
                    <br>
                    <small class="text-muted">Enviado: {{ formatDate(p.fechaEnvio) }}</small>
                </li>
            </ul>
            <ul class="list-group" v-if="viewState==='PropuestasRecibidas' ">
                <li v-for="p in items" :key="p.id" class="list-group-item list-group-item-action position-relative"
                    :class="{ active: selected && selected.id === p.id }" @@click="selectPropuesta(p)">

                    <!-- Badge de estado -->
                    <span v-if="p.isAceptada" class="badge bg-success position-absolute top-0 end-0 m-2">
                        Aceptada
                    </span>
                    <span v-else class="badge bg-secondary position-absolute top-0 end-0 m-2">
                        Pendiente
                    </span>

                    <!-- Contenido principal -->
                    <strong>{{ p.mensaje }}</strong>
                    <br>
                    <small class="text-muted">Enviado: {{ formatDate(p.fechaEnvio) }}</small>
                </li>
            </ul>
            <nav v-if="totalPages>1" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item" :class="{ disabled: page===1 }">
                        <a class="page-link" href="#" @@click.prevent="changePage(page-1)">«</a>
                    </li>
                    <li class="page-item" v-for="p in totalPages" :key="p" :class="{ active: p===page }">
                        <a class="page-link" href="#" @@click.prevent="changePage(p)">{{ p }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: page===totalPages }">
                        <a class="page-link" href="#" @@click.prevent="changePage(page+1)">»</a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Columna derecha: detalle de propuesta seleccionada -->
        <div class="col-md-3">
            <!-- Detalle de propuesta -->
            <div v-if="selected && viewState==='PropuestasEnviadas' " class="card">
                <div class="card-body">
                    <h4 class="card-title">Vacante</h4>
                    <h5 class="card-title">{{ selected.vacante.titulo }}</h5>
                    <p><strong>Descripción Vacante:</strong> {{ selected.vacante.descripcion }}</p>
                    <p><strong>Creador Vacante:</strong> {{ selected.vacante.usuario.nombre }} {{
                        selected.vacante.usuario.apellido }}</p>
                    <hr>
                    <h4 class="card-title">Propuesta</h4>
                    <p><strong>Mensaje:</strong></p>
                    <p>{{ selected.mensaje }}</p>
                    <p><strong>Monto Ofrecido:</strong> {{ selected.monto }}</p>
                    <p><strong>Fecha Envío:</strong> {{ formatDate(selected.fechaEnvio) }}</p>
                    <p><strong>Estado:</strong>
                        <span v-if="selected.isAceptada" class="badge bg-success">Aceptada</span>
                        <span v-else-if="selected.isRechazada" class="badge bg-danger">Rechazada</span>
                        <span v-else class="badge bg-secondary">Pendiente</span>
                    </p>
                </div>
            </div>

            <div v-if="selected && viewState === 'PropuestasRecibidas'" class="card mt-3 shadow-sm">
                <div class="card-body">
                    <!-- Perfil del usuario -->
                    <div class="d-flex align-items-center mb-3">
                        <img :src="selected.usuario.avatarUrl || '/img/default-avatar.png'" alt="Avatar"
                            class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                        <div>
                            <small class="text-muted">
                                <a :href="`/Perfil/Index/${selected.usuario.id}`" class="text-decoration-none">
                                    {{ selected.usuario.nombre }} {{ selected.usuario.apellido }}
                                </a>
                            </small>

                        </div>
                    </div>

                    <!-- Propuesta -->

                    <p><strong>Mensaje:</strong></p>
                    <p class="fst-italic">{{ selected.mensaje }}</p>

                    <p><strong>Monto Ofrecido:</strong> ${{ selected.monto }}</p>
                    <p><strong>Fecha de Envío:</strong> {{ formatDate(selected.fechaEnvio) }}</p>

                    <p><strong>Estado:</strong>
                        <span v-if="selected.isAceptada" class="badge bg-success">Aceptada</span>
                        <span v-else-if="selected.isRechazada" class="badge bg-danger">Rechazada</span>
                        <span v-else class="badge bg-secondary">Pendiente</span>
                    </p>

                    <!-- Botón para crear contrato -->
                    <div class="text-end mt-4">
                        <button v-if="!selected.isAceptada" @@click="abrirModalContrato"
                            class="btn btn-outline-success">
                            Crear Contrato
                        </button>

                    </div>
                </div>
            </div>

            <div v-else class="text-center text-muted mt-3">Selecciona una propuesta</div>
        </div>
    </div>

    <!-- MODAL CREAR CONTRATO -->
    <div v-if="modalVisible"
        class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-5" style="max-width: 500px; width: 100%;">
            <h5 class="mb-3">Crear Contrato</h5>

            <div class="mb-2">
                <strong>Vacante:</strong> {{ selected.vacante?.titulo }}
            </div>
            <div class="mb-2">
                <strong>Monto Ofrecido:</strong> ${{ selected.monto }}
            </div>
            <div v-if="error" class="alert alert-danger">{{ error }}</div>
            <div class="mb-3">
                <label>Fecha límite de entrega:</label>
                <input v-model="fechaLimite" type="date" class="form-control mt-1" />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary" @@click="modalVisible = false">Cancelar</button>
                <button class="btn btn-success" @@click="crearContrato">Confirmar</button>
            </div>
        </div>
    </div>

</div>




@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        createApp({
            setup() {

                /* ---------------------------------------------
                 * REFS (estado reactivo principal)
                 * --------------------------------------------- */
                const items = ref([]);              // propuestas
                const itemsVacantes = ref([]);      // vacantes que tienen propuestas
                const selected = ref(null);         // propuesta seleccionada

                const page = ref(1);
                const size = ref(5);
                const total = ref(0);

                const loading = ref(false);
                const error = ref(null);

                const lastList = ref('PropuestasEnviadas');
                const viewState = ref('PropuestasEnviadas');


                /* ---------------------------------------------
                 * COMPUTED
                 * --------------------------------------------- */
                const totalPages = computed(() => Math.ceil(total.value / size.value) || 1);

                const title = computed(() => {
                    switch (viewState.value) {
                        case 'PropuestasEnviadas': return 'Propuestas Enviadas';
                        case 'PropuestasRecibidas': return 'Propuestas Recibidas';
                        default: return '';
                    }
                });

                const nonItemaText = computed(() => {
                    switch (viewState.value) {
                        case 'PropuestasEnviadas': return 'No has enviado propuestas aún.';
                        case 'PropuestasRecibidas': return 'No tienes propuestas recibidas.';
                        default: return '';
                    }
                });

                const formatDate = (iso) =>
                    iso ? new Date(iso).toLocaleDateString('es-AR') : '';


                /* ---------------------------------------------
                 * VALIDACIONES
                 * --------------------------------------------- */
                const validarFecha = (dateStr) => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const minDate = new Date(today);
                    minDate.setDate(minDate.getDate() + 5); // mínimo +5 días

                    const input = new Date(dateStr);
                    return input >= minDate;
                };


                /* ---------------------------------------------
                 * CAMBIO DE VISTAS
                 * --------------------------------------------- */
                function switchView(mode) {
                    selected.value = null;

                    if (mode === 'PropuestasEnviadas') {
                        lastList.value = mode;
                        viewState.value = mode;
                        loadPropuestas();

                    } else if (mode === 'PropuestasRecibidas') {
                        lastList.value = mode;
                        viewState.value = mode;
                        loadVacantes();
                        items.value = [];
                    }
                }


                /* ---------------------------------------------
                 * CARGA DE VACANTES
                 * --------------------------------------------- */
                const loadVacantes = async () => {
                    try {
                        loading.value = true;
                        const { data } = await axios.get('/api/vacantes/mis-vacantes-con-propuestas');
                        itemsVacantes.value = data;
                    } catch (err) {
                        console.error("Error al cargar vacantes:", err);
                    } finally {
                        loading.value = false;
                    }
                };


                /* ---------------------------------------------
                 * SELECCIONAR VACANTE
                 * --------------------------------------------- */
                const seleccionarVacante = (vacante) => {
                    selected.value = null;
                    items.value = [];
                    loadPropuestas(vacante.id);
                };


                /* ---------------------------------------------
                 * CARGA DE PROPUESTAS
                 * --------------------------------------------- */
                async function loadPropuestas(vacanteId = null) {
                    try {
                        loading.value = true;

                        const params = {
                            page: page.value,
                            size: size.value,
                            mias: true
                        };

                        if (vacanteId) params.vacanteId = vacanteId;

                        const { data } = await axios.get('/api/propuestas/listar', { params });

                        total.value = data.total;
                        items.value = data.items;

                    } catch (err) {
                        console.error("Error al cargar propuestas:", err);
                    } finally {
                        loading.value = false;
                    }
                }


                /* ---------------------------------------------
                 * SELECCIONAR PROPUESTA
                 * --------------------------------------------- */
                const selectPropuesta = (p) => {
                    selected.value = p;
                };


                /* ---------------------------------------------
                 * PAGINADO
                 * --------------------------------------------- */
                const changePage = (n) => {
                    if (n < 1 || n > totalPages.value) return;
                    page.value = n;
                    loadPropuestas();
                };


                /* ---------------------------------------------
                 * CARGA INICIAL
                 * --------------------------------------------- */
                loadPropuestas();


                /* ---------------------------------------------
                 * MODAL DE CONTRATO
                 * --------------------------------------------- */
                const modalVisible = ref(false);
                const fechaLimite = ref(null);

                const abrirModalContrato = () => {
                    if (!selected.value) return;
                    fechaLimite.value = null;
                    modalVisible.value = true;
                };

                const crearContrato = async () => {
                    if (!selected.value || !fechaLimite.value) {
                        error.value = "Selecciona una propuesta y establece una fecha límite.";
                        return;
                    }

                    if (!validarFecha(fechaLimite.value)) {
                        error.value = "La fecha límite debe ser mínimo a los 5 días.";
                        return;
                    }

                    try {
                        const today = new Date();

                        const contratoData = {
                            PropuestaId: selected.value.id,
                            FechaLimite: fechaLimite.value,
                            FechaCreacion: today.toISOString().split('T')[0],
                            isActive: true,
                            isCancelled: false,
                            ContratadoId: selected.value.usuario.id,
                            estado_disputa: "Ninguna"
                        };

                        const payload = {
                            Contrato: contratoData,
                            Monto: selected.value.monto
                        };

                        const response = await axios.post('/api/contratos', payload);

                        if (response.status === 200 || response.status === 201) {
                            await loadPropuestas(selected.value.vacanteId);

                            // aceptar propuesta luego de crear contrato
                            try {
                                await axios.patch(`/api/propuestas/${selected.value.id}/aceptar`, {
                                    propuestaId: selected.value.id
                                });
                            } catch (err) {
                                console.error("Contrato creado, pero fallo aceptar propuesta:", err);
                            }

                            modalVisible.value = false;
                            selected.value = null;
                        }

                    } catch (err) {
                        console.error("Error creando contrato:", err);
                        alert("Error al crear contrato: " + (err.response?.data || err.message));
                    }
                };


                /* ---------------------------------------------
                 * RETORNO A LA VISTA
                 * --------------------------------------------- */
                return {
                    items, itemsVacantes, selected,
                    page, totalPages,
                    loading, error,

                    title, nonItemaText, formatDate,
                    viewState, switchView,

                    selectPropuesta, seleccionarVacante,
                    changePage, abrirModalContrato, crearContrato,

                    modalVisible, fechaLimite
                };
            }
        }).mount('#propuestas-app');
    </script>
}